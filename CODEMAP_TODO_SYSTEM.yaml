title: "Todo System Flow"
created: "2026-01-11T00:00:00Z"
summary: "Task tracking: TodoWrite tool -> pointer-based state -> session persistence -> reminder injection"
description: |
  ## Overview
  The todo system provides task tracking for multi-step operations. Agent uses
  TodoWrite to manage tasks [1a], state stored via pointer in tools.Config [1b-1c],
  main.go owns the slice [1d], persisted via session JSON [2a-2b], with reminder
  nudges after 3 turns [3a-3d].

  ## Key Flow
  1. Tool execution: TodoWrite replaces full list via configTodos pointer [1a-1e]
  2. Session persistence: main.go owns sessionTodos, passes pointer to Init [2a-2b]
  3. Reminder injection: turnsSinceTodoWrite counter, hasPending computed in main.go, nudge after 3 turns [3a-3d]

sections:
  - id: 1
    title: "TodoWrite Tool"
    summary: "Tool registration, execution, and pointer-based state"
    tree:
      - text: "Tool registered in init() with schema for todos array"
        children:
          - block:
              id: "1a"
              title: "Tool registration"
              code: |
                register(claude.Tool{
                    Name: "TodoWrite",
                    Description: `Use this tool to create and manage a structured task list...`,
                    InputSchema: claude.InputSchema{...},
                }, executeTodo)
              file: "tools/todo.go"
              line: 17
            children:
              - text: "Todo struct defines task with content, active_form, status"
                children:
                  - block:
                      id: "1b"
                      title: "Todo struct"
                      code: |
                        type Todo struct {
                            Content    string `json:"content"`
                            ActiveForm string `json:"active_form"`
                            Status     string `json:"status"` // pending, in_progress, completed
                        }
                      file: "tools/todo.go"
                      line: 10
                    children:
                      - text: "Package-level pointer to external slice (set via Init)"
                        children:
                          - block:
                              id: "1c"
                              title: "configTodos pointer"
                              code: "var configTodos *[]Todo"
                              file: "tools/tools.go"
                              line: 12
      - text: "executeTodo handler replaces entire list via pointer dereference"
        children:
          - block:
              id: "1d"
              title: "executeTodo"
              code: |
                func executeTodo(input json.RawMessage) Result {
                    var args struct {
                        Todos []Todo `json:"todos"`
                    }
                    if err := json.Unmarshal(input, &args); err != nil {
                        return newResult("TodoWrite", Error(err.Error()))
                    }
                    *configTodos = args.Todos
                    return todoResult{output: fmt.Sprintf(`{"success":true,"count":%d}`, len(args.Todos))}
                }
              file: "tools/todo.go"
              line: 238
            children:
              - text: "Returns todoResult which renders via RenderTodos"
                children:
                  - block:
                      id: "1e"
                      title: "todoResult"
                      code: |
                        type todoResult struct {
                            output string
                        }
                        func (r todoResult) String() string { return r.output }
                        func (r todoResult) Render()        { RenderTodos(*configTodos) }
                      file: "tools/todo.go"
                      line: 231

  - id: 2
    title: "State & Persistence"
    summary: "main.go owns sessionTodos, passed to tools.Init and Agent"
    tree:
      - text: "main.go owns the sessionTodos slice"
        children:
          - block:
              id: "2a"
              title: "sessionTodos declaration"
              code: |
                var (
                    baseURL      = getEnvOrDefault("ANTHROPIC_BASE_URL", "...")
                    model        = getEnvOrDefault("ANTHROPIC_MODEL", "...")
                    sessionTodos []tools.Todo
                )
              file: "main.go"
              line: 71
            children:
              - text: "Pointer passed to tools.Init via Config.Todos in AgentSession"
                children:
                  - block:
                      id: "2b"
                      title: "Init with Todos pointer"
                      code: |
                        tools.Init(tools.Config{
                            MCPClients:      mcpClients,
                            PermissionsMode: permissionsMode,
                            RuleMatcher:     GetMatchingRules,
                            SkillLoader:     makeSkillLoader(),
                            Todos:           &sessionTodos,
                            ...
                        })
                      file: "cli.go"
                      line: 85
      - text: "Config.Todos field stores pointer for tool mutation"
        children:
          - block:
              id: "2c"
              title: "Config struct"
              code: |
                type Config struct {
                    MCPClients      *MCPClients
                    PermissionsMode string
                    RuleMatcher     func(string) (string, []string)
                    SkillLoader     func(string) (*SkillInfo, error)
                    Subagent        *SubagentConfig
                    Todos           *[]Todo // pointer so tool can mutate
                }
              file: "tools/tools.go"
              line: 19
            children:
              - text: "Init assigns configTodos from cfg.Todos"
                children:
                  - block:
                      id: "2d"
                      title: "Init configTodos assignment"
                      code: "configTodos = cfg.Todos"
                      file: "tools/tools.go"
                      line: 45
      - text: "Agent.Save() persists todos via saveSession"
        children:
          - block:
              id: "2e"
              title: "agent.Save call from cli.go"
              code: |
                if err := agent.Save(); err != nil {
                    fmt.Println(tools.Error(fmt.Sprintf("save failed: %v", err)))
                }
              file: "cli.go"
              line: 142
            children:
              - block:
                  id: "2e2"
                  title: "Save method"
                  code: |
                    func (a *Agent) Save() error {
                        if err := saveSession(a.sessionID, a.messages, *a.todos, a.planMode, a.permissionsMode); err != nil {
                            return err
                        }
                        a.turnsSinceTodoWrite++
                        return nil
                    }
                  file: "agent.go"
                  line: 102

  - id: 3
    title: "Reminder System"
    summary: "Nudge injection after 3 turns without TodoWrite (Agent tracks counter)"
    tree:
      - text: "Agent.turnsSinceTodoWrite tracks turns"
        children:
          - block:
              id: "3a"
              title: "Counter in Agent struct"
              code: |
                type Agent struct {
                    ...
                    turnsSinceTodoWrite int
                    ...
                }
              file: "agent.go"
              line: 13
            children:
              - text: "Reset to 0 when TodoWrite executed"
                children:
                  - block:
                      id: "3b"
                      title: "Counter reset in RunInferenceTurn"
                      code: |
                        if block.Name == "TodoWrite" {
                            a.turnsSinceTodoWrite = 0
                        }
                      file: "agent.go"
                      line: 167
              - text: "Increment in Save() after each user turn"
                children:
                  - block:
                      id: "3c"
                      title: "Counter increment in Save"
                      code: "a.turnsSinceTodoWrite++"
                      file: "agent.go"
                      line: 109
      - text: "hasPending computed in RunInferenceTurn before GetReminders"
        children:
          - block:
              id: "3d"
              title: "hasPending computation"
              code: |
                hasPending := false
                for _, t := range *a.todos {
                    if t.Status == "pending" || t.Status == "in_progress" {
                        hasPending = true
                        break
                    }
                }
              file: "agent.go"
              line: 188
      - text: "AgentState now includes HasPendingTodos field"
        children:
          - block:
              id: "3e"
              title: "AgentState struct"
              code: |
                type AgentState struct {
                    PlanMode            bool
                    TurnsSinceTodoWrite int
                    HasPendingTodos     bool
                }
              file: "reminders.go"
              line: 6
      - text: "todoReminder uses state.HasPendingTodos"
        children:
          - block:
              id: "3f"
              title: "todoReminder"
              code: |
                func todoReminder(state *AgentState) string {
                    if state.TurnsSinceTodoWrite >= 3 && state.HasPendingTodos {
                        return `<system-reminder>
                The TodoWrite tool hasn't been used recently...
                </system-reminder>`
                    }
                    return ""
                }
              file: "reminders.go"
              line: 24
            children:
              - text: "Injected via GetReminders into tool result in RunInferenceTurn"
                children:
                  - block:
                      id: "3g"
                      title: "GetReminders call"
                      code: |
                        state := &AgentState{
                            PlanMode:            a.planMode,
                            TurnsSinceTodoWrite: a.turnsSinceTodoWrite,
                            HasPendingTodos:     hasPending,
                        }
                        if reminders := GetReminders(state); reminders != "" {
                            last := &toolResults[len(toolResults)-1]
                            last.Content += "\n" + reminders
                        }
                      file: "agent.go"
                      line: 195

  - id: 4
    title: "Display"
    summary: "RenderTodos formats output with status icons"
    tree:
      - text: "RenderTodos prints todos with checkboxes and styling"
        children:
          - block:
              id: "4a"
              title: "RenderTodos"
              code: |
                func RenderTodos(t []Todo) {
                    fmt.Println()
                    fmt.Println(Status("todos"))
                    for _, todo := range t {
                        text := todo.Content
                        if todo.Status == "in_progress" && todo.ActiveForm != "" {
                            text = todo.ActiveForm
                        }
                        styled := text
                        switch todo.Status {
                        case "completed":
                            styled = Dim(text)
                        case "in_progress":
                            styled = Highlight(text)
                        }
                        fmt.Printf("  %s %s\n", Checkbox(todo.Status), styled)
                    }
                }
              file: "tools/todo.go"
              line: 250
