name: Codemap Validation

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
    paths:
      - "**/*.go"
      - "CODEMAP_*.yaml"

jobs:
  validate-codemaps:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate Codemaps
        uses: anthropics/claude-code-action@v1
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          claude_args: '--allowed-tools "Bash(gh pr comment:*),Bash(ls:*),Bash(cat:*),Read,Glob,Grep"'
          prompt: |
            Validate all CODEMAP_*.yaml files in this repo are accurate.

            ## Codemap Schema

            ```yaml
            title: "Flow Name"                    # REQUIRED
            created: "2024-01-15T10:00:00Z"       # REQUIRED - ISO 8601
            summary: "One sentence"               # REQUIRED
            description: |                        # OPTIONAL
              Overview with [1a] refs.

            sections:                             # REQUIRED
              - id: 1                             # REQUIRED - integer
                title: "Section Name"             # REQUIRED
                tree:                             # REQUIRED
                  - text: "Context"               # text OR block, not both
                    children:
                      - block:
                          id: "1a"                # format: <section><letter>
                          title: "Short title"
                          code: "singleLine()"   # ONE LINE ONLY
                          file: "path/file.go"   # relative path, must exist
                          line: 42               # exact line, 1-indexed
            ```

            ## Instructions

            1. Run: `ls CODEMAP_*.yaml` to find codemaps
            2. If no codemaps exist, run this exact command then stop:
               `gh pr comment $PR_NUMBER --body "Codemap Validation: No codemaps found"`
            3. For each codemap, read it and check each block's file:line has matching code
            4. MANDATORY: Run `gh pr comment` to post results - do not skip this step

            If all valid:
            `gh pr comment $PR_NUMBER --body "Codemap Validation: All codemaps up-to-date"`

            If issues:
            `gh pr comment $PR_NUMBER --body "Codemap Validation FAILED: [list issues]"`
            Then: `exit 1`
