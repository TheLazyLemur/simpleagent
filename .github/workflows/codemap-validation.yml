name: Codemap Validation

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
    paths:
      - "**/*.go"
      - "CODEMAP_*.yaml"

jobs:
  validate-codemaps:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      issues: read
      id-token: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate Codemaps
        uses: anthropics/claude-code-action@v1
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            Validate all CODEMAP_*.yaml files in this repo are accurate.

            ## Codemap Schema

            ```yaml
            title: "Flow Name"                    # REQUIRED
            created: "2024-01-15T10:00:00Z"       # REQUIRED - ISO 8601
            summary: "One sentence"               # REQUIRED
            description: |                        # OPTIONAL
              Overview with [1a] refs.

            sections:                             # REQUIRED
              - id: 1                             # REQUIRED - integer
                title: "Section Name"             # REQUIRED
                tree:                             # REQUIRED
                  - text: "Context"               # text OR block, not both
                    children:
                      - block:
                          id: "1a"                # format: <section><letter>
                          title: "Short title"
                          code: "singleLine()"   # ONE LINE ONLY
                          file: "path/file.go"   # relative path, must exist
                          line: 42               # exact line, 1-indexed
            ```

            ## Validation

            1. Find all CODEMAP_*.yaml files (if none exist, validation passes)
            2. For each codemap:
               - Verify file paths exist
               - Verify line numbers are correct (read file, check line)
               - Verify `code` field matches actual code at that line
            3. Post result to PR using: `gh pr comment $PR_NUMBER --body "..."`

            ## Output Format

            If ALL codemaps valid:
            ```
            gh pr comment $PR_NUMBER --body "## Codemap Validation

            All codemaps are up-to-date."
            ```

            If ANY issues found:
            ```
            gh pr comment $PR_NUMBER --body "## Codemap Validation

            **Issues found:**
            - CODEMAP_X.yaml: line 42 references file.go:50 but code has changed
            - ..."
            ```
            Then exit with error: `exit 1`
