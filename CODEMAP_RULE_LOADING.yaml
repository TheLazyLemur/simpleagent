title: "Rule Loading Flow"
created: "2025-01-11T00:00:00Z"
summary: "How rules are loaded from .rules and .claude/rules directories into the system prompt"
description: |
  ## Overview
  Rules are markdown files with optional YAML frontmatter loaded at startup via [1a].
  The flow searches directories [1b], parses frontmatter [2a], and separates always-loaded
  rules [2b] from conditional pattern-matched rules [3a].

  ## Key Components
  - Entry point at [1a] in BuildSystemPrompt
  - Directory search at [1b] with parent traversal via findInAncestors [1d]
  - Frontmatter parsing at [2a]
  - Always-rules formatting at [2b]
  - Conditional matching wired via tools.Init [4a-4c], matcher at [4e]

sections:
  - id: 1
    title: "Entry & Directory Discovery"
    summary: "BuildSystemPrompt triggers rule loading, searches for rule directories"
    tree:
      - text: "main.go calls BuildSystemPrompt at startup"
        children:
          - block:
              id: "1a"
              title: "BuildSystemPrompt calls LoadRules"
              code: "_, rules := LoadRules()"
              file: "config.go"
              line: 168
            children:
              - text: "LoadRules iterates over both .rules and .claude/rules"
                children:
                  - block:
                      id: "1b"
                      title: "Search both rule directories"
                      code: "for _, dirName := range []string{rulesDirName, \".claude/rules\"} {"
                      file: "config.go"
                      line: 233
                    children:
                      - block:
                          id: "1c"
                          title: "findDir calls findInAncestors"
                          code: "rulesDir := findDir(dirName)"
                          file: "config.go"
                          line: 235
                        children:
                          - block:
                              id: "1d"
                              title: "findInAncestors checks if path exists"
                              code: "if err == nil && (!mustBeDir || info.IsDir()) {"
                              file: "config.go"
                              line: 74

  - id: 2
    title: "File Parsing"
    summary: "Read rule files, extract frontmatter, build ruleFile structs"
    tree:
      - text: "For each .md/.txt file in the rules directory"
        children:
          - block:
              id: "2a"
              title: "Parse YAML frontmatter"
              code: "fm, body := ParseFrontmatter(string(data))"
              file: "config.go"
              line: 263
            children:
              - block:
                  id: "2b"
                  title: "Unmarshal frontmatter to Rule struct"
                  code: "yaml.Unmarshal([]byte(fm), &rule)"
                  file: "config.go"
                  line: 270
                children:
                  - block:
                      id: "2c"
                      title: "Append to rules slice"
                      code: "rules = append(rules, ruleFile{"
                      file: "config.go"
                      line: 273

  - id: 3
    title: "Rule Categorization"
    summary: "Separate always-loaded rules from conditional pattern-matched rules"
    tree:
      - text: "Rules without a pattern are always loaded into system prompt"
        children:
          - block:
              id: "3a"
              title: "Format always-loaded rules"
              code: "alwaysRules := formatAlwaysRules(rules)"
              file: "config.go"
              line: 169
            children:
              - block:
                  id: "3b"
                  title: "Check if rule has no pattern"
                  code: "if r.Pattern == \"\" {"
                  file: "config.go"
                  line: 292
                children:
                  - block:
                      id: "3c"
                      title: "Wrap in rule tags"
                      code: "always = append(always, wrapXML(\"rule\", r.SourceFile, r.Content))"
                      file: "config.go"
                      line: 293

  - id: 4
    title: "Conditional Rule Matching"
    summary: "Pattern-matched rules injected when files are accessed"
    tree:
      - text: "Rules with patterns are matched against file paths at runtime"
        children:
          - block:
              id: "4a"
              title: "Config struct with RuleMatcher field"
              code: "RuleMatcher func(string) (string, []string)"
              file: "tools/tools.go"
              line: 23
            children:
              - block:
                  id: "4b"
                  title: "Init passes RuleMatcher via Config"
                  code: "tools.Init(tools.Config{...RuleMatcher: GetMatchingRules,...})"
                  file: "cli.go"
                  line: 85
                children:
                  - block:
                      id: "4c"
                      title: "Init sets RuleMatcher from cfg"
                      code: "RuleMatcher = cfg.RuleMatcher"
                      file: "tools/tools.go"
                      line: 43
                    children:
                      - block:
                          id: "4d"
                          title: "RuleMatcher var in fs.go"
                          code: "var RuleMatcher func(filePath string) (string, []string)"
                          file: "tools/fs.go"
                          line: 15
                        children:
                          - block:
                              id: "4e"
                              title: "Match pattern against file path"
                              code: "if match, _ := doublestar.Match(r.Pattern, relPath); match {"
                              file: "config.go"
                              line: 320
                            children:
                              - block:
                                  id: "4f"
                                  title: "Append matched rule content"
                                  code: "matched = append(matched, wrapXML(\"rule\", r.SourceFile, r.Content))"
                                  file: "config.go"
                                  line: 321
