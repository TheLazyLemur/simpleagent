title: "Session Persistence Flow"
created: "2026-01-11T00:00:00Z"
summary: "Session management: UUID v7 generation, JSON persistence, list/resume/delete operations"
description: |
  ## Overview
  Session persistence stores conversation state in JSON files at ~/.config/agent/sessions/<uuid>.json.
  Uses UUID v7 for time-ordered session IDs. Supports resume, list, and delete operations via CLI flags.

  ## Key Data Structures
  - SessionMeta: ID, timestamps, model name
  - SessionFile: Meta + Messages + Todos + PlanMode + PermissionsMode

  ## CLI Flags
  - `-resume <id>`: Load existing session
  - `-sessions`: List all sessions
  - `-delete <id>`: Remove session file

sections:
  - id: 1
    title: "Session ID Generation"
    summary: "UUID v7 for time-ordered unique IDs"
    tree:
      - text: "Uses google/uuid for UUID v7 generation"
        children:
          - block:
              id: "1a"
              title: "newSessionID"
              code: |
                func newSessionID() string {
                    id, _ := uuid.NewV7()
                    return id.String()
                }
              file: "session.go"
              line: 35
            children:
              - text: "Called when no -resume flag provided"
                children:
                  - block:
                      id: "1b"
                      title: "New session branch"
                      code: "sessionID = newSessionID()"
                      file: "main.go"
                      line: 142

  - id: 2
    title: "Session Save"
    summary: "JSON persistence after each user turn"
    tree:
      - text: "saveSession builds SessionFile struct"
        children:
          - block:
              id: "2a"
              title: "Build SessionFile"
              code: |
                sess := SessionFile{
                    Meta: SessionMeta{
                        ID:        id,
                        UpdatedAt: time.Now(),
                        Model:     "MiniMax-M2.1",
                    },
                    Messages:        messages,
                    Todos:           todos,
                    PlanMode:        planMode,
                    PermissionsMode: permissionsMode,
                }
              file: "session.go"
              line: 45
            children:
              - text: "Preserves CreatedAt from existing session if found"
                children:
                  - block:
                      id: "2b"
                      title: "Preserve CreatedAt"
                      code: |
                        if existing, err := loadSession(id); err == nil {
                            sess.Meta.CreatedAt = existing.Meta.CreatedAt
                        } else {
                            sess.Meta.CreatedAt = time.Now()
                        }
                      file: "session.go"
                      line: 57
                    children:
                      - text: "Writes JSON to session file"
                        children:
                          - block:
                              id: "2c"
                              title: "Write JSON"
                              code: |
                                data, _ := json.MarshalIndent(sess, "", "  ")
                                os.WriteFile(sessionPath(id), data, 0644)
                              file: "session.go"
                              line: 63
      - text: "Called after agentic loop - uses sessionTodos directly (main.go owns state)"
        children:
          - block:
              id: "2d"
              title: "Save call site"
              code: "saveSession(sessionID, messages, sessionTodos, planMode, tools.GetPermissionsMode())"
              file: "main.go"
              line: 314

  - id: 3
    title: "Session Load"
    summary: "Resume session from JSON file"
    tree:
      - text: "loadSession reads and unmarshals JSON"
        children:
          - block:
              id: "3a"
              title: "loadSession"
              code: |
                func loadSession(id string) (*SessionFile, error) {
                    data, err := os.ReadFile(sessionPath(id))
                    if err != nil {
                        return nil, err
                    }
                    var sess SessionFile
                    json.Unmarshal(data, &sess)
                    return &sess, nil
                }
              file: "session.go"
              line: 67
      - text: "main.go handles -resume flag"
        children:
          - block:
              id: "3b"
              title: "Resume flag check"
              code: "if *resumeFlag != \"\""
              file: "main.go"
              line: 121
            children:
              - text: "Loads session and restores state"
                children:
                  - block:
                      id: "3c"
                      title: "Load session"
                      code: "sess, err := loadSession(*resumeFlag)"
                      file: "main.go"
                      line: 122
                    children:
                      - text: "Restores messages, todos, modes - assigns directly to sessionTodos (no tools.SetTodos)"
                        children:
                          - block:
                              id: "3d"
                              title: "Restore state"
                              code: |
                                messages = sess.Messages
                                sessionTodos = sess.Todos
                                planMode = sess.PlanMode
                                sessionID = sess.Meta.ID
                                if sess.PermissionsMode != "" {
                                    permissionsMode = sess.PermissionsMode
                                }
                              file: "main.go"
                              line: 127

  - id: 4
    title: "Session List"
    summary: "List all sessions sorted by update time"
    tree:
      - text: "listSessions reads session directory"
        children:
          - block:
              id: "4a"
              title: "Read dir"
              code: "entries, err := os.ReadDir(sessionDir)"
              file: "session.go"
              line: 78
            children:
              - text: "Iterates .json files, loads each"
                children:
                  - block:
                      id: "4b"
                      title: "Load each session"
                      code: |
                        for _, e := range entries {
                            if !strings.HasSuffix(e.Name(), ".json") {
                                continue
                            }
                            sess, err := loadSession(strings.TrimSuffix(e.Name(), ".json"))
                      file: "session.go"
                      line: 89
                    children:
                      - text: "Sorts by UpdatedAt descending"
                        children:
                          - block:
                              id: "4c"
                              title: "Sort sessions"
                              code: |
                                slices.SortFunc(sessions, func(a, b SessionFile) int {
                                    return b.Meta.UpdatedAt.Compare(a.Meta.UpdatedAt)
                                })
                              file: "session.go"
                              line: 105
                            children:
                              - text: "Renders table with lipgloss styling"
                                children:
                                  - block:
                                      id: "4d"
                                      title: "Table output"
                                      code: |
                                        fmt.Printf("  %s  %s  %s  %s\n",
                                            idStyle.Width(36).Render(s.Meta.ID),
                                            cellStyle.Width(16).Render(s.Meta.CreatedAt.Format("2006-01-02 15:04")),
                                            cellStyle.Width(16).Render(s.Meta.UpdatedAt.Format("2006-01-02 15:04")),
                                            cellStyle.Render(fmt.Sprintf("%d", len(s.Messages))),
                                        )
                                      file: "session.go"
                                      line: 124
      - text: "main.go handles -sessions flag"
        children:
          - block:
              id: "4e"
              title: "Sessions flag"
              code: |
                case *listFlag:
                    listSessions()
                    return
              file: "main.go"
              line: 104

  - id: 5
    title: "Session Delete"
    summary: "Remove session file from disk"
    tree:
      - text: "deleteSession checks existence then removes"
        children:
          - block:
              id: "5a"
              title: "deleteSession"
              code: |
                func deleteSession(id string) {
                    path := sessionPath(id)
                    if _, err := os.Stat(path); os.IsNotExist(err) {
                        fmt.Println(tools.Error(fmt.Sprintf("session %s not found", id)))
                        return
                    }
                    os.Remove(path)
                    fmt.Println(tools.Success("deleted " + id))
                }
              file: "session.go"
              line: 134
      - text: "main.go handles -delete flag"
        children:
          - block:
              id: "5b"
              title: "Delete flag"
              code: |
                case *deleteFlag != "":
                    deleteSession(*deleteFlag)
                    return
              file: "main.go"
              line: 107

  - id: 6
    title: "Session Path Helper"
    summary: "Constructs file path from session ID"
    tree:
      - text: "sessionPath joins dir + id + .json"
        children:
          - block:
              id: "6a"
              title: "sessionPath"
              code: |
                func sessionPath(id string) string {
                    return filepath.Join(sessionDir, id+".json")
                }
              file: "session.go"
              line: 40
      - text: "sessionDir defined as package var"
        children:
          - block:
              id: "6b"
              title: "sessionDir"
              code: "var sessionDir = filepath.Join(os.Getenv(\"HOME\"), \".config\", \"agent\", \"sessions\")"
              file: "session.go"
              line: 18

  - id: 7
    title: "Todo State Ownership"
    summary: "main.go owns sessionTodos, passes pointer to tools.Init"
    tree:
      - text: "sessionTodos declared as package-level var in main.go"
        children:
          - block:
              id: "7a"
              title: "sessionTodos var"
              code: "sessionTodos []tools.Todo"
              file: "main.go"
              line: 76
            children:
              - text: "Pointer passed to tools.Init for tool access"
                children:
                  - block:
                      id: "7b"
                      title: "tools.Init with Todos pointer"
                      code: |
                        tools.Init(tools.Config{
                            ...
                            Todos: &sessionTodos,
                            ...
                        })
                      file: "main.go"
                      line: 167
      - text: "Direct assignment on session restore (no tools.SetTodos)"
        children:
          - block:
              id: "7c"
              title: "Direct restore"
              code: "sessionTodos = sess.Todos"
              file: "main.go"
              line: 128
      - text: "Passed directly to saveSession (no tools.GetTodos)"
        children:
          - block:
              id: "7d"
              title: "Direct save"
              code: "saveSession(sessionID, messages, sessionTodos, planMode, tools.GetPermissionsMode())"
              file: "main.go"
              line: 314
