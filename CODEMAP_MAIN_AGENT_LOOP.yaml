title: "Main Agent Loop"
created: "2026-01-11T00:00:00Z"
summary: "CLI agentic loop: user input -> API stream -> tool execution -> repeat"
description: |
  ## Overview
  The main agent loop in [1a] reads user input, sends to Claude API [2a],
  streams responses [2b], executes tools [3a], and persists sessions [4a].

  ## Key Flow
  1. Initialization: globals, client setup, session load/create, tools.Init [1a-1h]
  2. Input handling: commands, bash shortcuts, user messages [2a-2e]
  3. Agentic loop: API streaming, text rendering, tool execution [3a-3o]
  4. Tool registry: dispatch and execution [4a-4d]
  5. Persistence: session save after each user turn [5a-5b]

sections:
  - id: 1
    title: "Initialization"
    summary: "Globals, client setup, session management, tools.Init"
    tree:
      - text: "Package-level globals for session state"
        children:
          - block:
              id: "1a"
              title: "Session todos global"
              code: "sessionTodos []tools.Todo"
              file: "main.go"
              line: 76
          - block:
              id: "1b"
              title: "Skill loader helper"
              code: "func makeSkillLoader() func(string) (*tools.SkillInfo, error) {"
              file: "main.go"
              line: 58
      - text: "Entry point parses flags for session management"
        children:
          - block:
              id: "1c"
              title: "Flag parsing"
              code: "resumeFlag := flag.String(\"resume\", \"\", \"Resume a session by ID\")"
              file: "main.go"
              line: 93
            children:
              - text: "Creates Claude client with configured base URL"
                children:
                  - block:
                      id: "1d"
                      title: "Client creation"
                      code: "client := claude.NewClient(claude.WithBaseURL(baseURL))"
                      file: "main.go"
                      line: 112
                    children:
                      - text: "Loads or creates session based on resume flag"
                        children:
                          - block:
                              id: "1e"
                              title: "Session resume"
                              code: "sess, err := loadSession(*resumeFlag)"
                              file: "main.go"
                              line: 122
                          - block:
                              id: "1f"
                              title: "New session"
                              code: "sessionID = newSessionID()"
                              file: "main.go"
                              line: 142
      - text: "Loads MCP servers from config"
        children:
          - block:
              id: "1g"
              title: "MCP client init"
              code: "mcpClients = tools.NewMCPClients(ctx, config.MCPServers)"
              file: "main.go"
              line: 154
            children:
              - text: "Builds system prompt from config and memory files"
                children:
                  - block:
                      id: "1h"
                      title: "System prompt"
                      code: "systemPrompt, loadedFiles, err := BuildSystemPrompt()"
                      file: "main.go"
                      line: 159
                    children:
                      - text: "Single tools.Init call configures all tool dependencies"
                        children:
                          - block:
                              id: "1i"
                              title: "tools.Init"
                              code: |
                                tools.Init(tools.Config{
                                    MCPClients:      mcpClients,
                                    PermissionsMode: permissionsMode,
                                    RuleMatcher:     GetMatchingRules,
                                    SkillLoader:     makeSkillLoader(),
                                    Todos:           &sessionTodos,
                                    Subagent: &tools.SubagentConfig{...},
                                })
                              file: "main.go"
                              line: 167

  - id: 2
    title: "Input Loop"
    summary: "User input handling and command processing"
    tree:
      - text: "Infinite loop waits for user input"
        children:
          - block:
              id: "2a"
              title: "Main loop start"
              code: "for {"
              file: "main.go"
              line: 180
            children:
              - text: "Reads multi-line input with continuation support"
                children:
                  - block:
                      id: "2b"
                      title: "Read input"
                      code: "input := readMultiLine(reader)"
                      file: "main.go"
                      line: 182
                    children:
                      - text: "Handles /plan command to toggle plan mode"
                        children:
                          - block:
                              id: "2c"
                              title: "Plan toggle"
                              code: "if input == \"/plan\" {"
                              file: "main.go"
                              line: 188
                      - text: "Handles !! prefix for bash with context"
                        children:
                          - block:
                              id: "2d"
                              title: "Bash context"
                              code: "if after, ok := strings.CutPrefix(input, \"!!\"); ok {"
                              file: "main.go"
                              line: 199
                      - text: "Appends user message to conversation"
                        children:
                          - block:
                              id: "2e"
                              title: "Add user msg"
                              code: "messages = append(messages, claude.MessageParam{Role: \"user\", Content: input})"
                              file: "main.go"
                              line: 218

  - id: 3
    title: "Agentic Loop"
    summary: "API streaming, response handling, tool execution"
    tree:
      - text: "Inner loop continues until no tool calls"
        children:
          - block:
              id: "3a"
              title: "Agentic loop"
              code: "for {"
              file: "main.go"
              line: 220
            children:
              - text: "Selects tool set based on plan mode"
                children:
                  - block:
                      id: "3b"
                      title: "Tool selection"
                      code: "toolSet := tools.All()"
                      file: "main.go"
                      line: 221
                    children:
                      - text: "Streams API request with thinking enabled"
                        children:
                          - block:
                              id: "3c"
                              title: "API stream"
                              code: "stream := client.Messages.Stream(claude.MessageCreateParams{"
                              file: "main.go"
                              line: 226
                            children:
                              - text: "Registers streaming callbacks for text and thinking"
                                children:
                                  - block:
                                      id: "3d"
                                      title: "Text callback"
                                      code: "stream.OnText(func(s string) {"
                                      file: "main.go"
                                      line: 236
                                  - block:
                                      id: "3e"
                                      title: "Thinking callback"
                                      code: "stream.OnThinking(func(s string) {"
                                      file: "main.go"
                                      line: 239
                              - text: "Waits for final message"
                                children:
                                  - block:
                                      id: "3f"
                                      title: "Final message"
                                      code: "msg, err := stream.FinalMessage()"
                                      file: "main.go"
                                      line: 243
                                    children:
                                      - text: "Renders text with glamour markdown"
                                        children:
                                          - block:
                                              id: "3g"
                                              title: "Render text"
                                              code: "rendered, err := mdRenderer.Render(text)"
                                              file: "main.go"
                                              line: 254
                                      - text: "Appends assistant message to history"
                                        children:
                                          - block:
                                              id: "3h"
                                              title: "Add assistant msg"
                                              code: "messages = append(messages, claude.MessageParam{Role: \"assistant\", Content: msg.Content})"
                                              file: "main.go"
                                              line: 265
      - text: "Iterates over content blocks for tool calls"
        children:
          - block:
              id: "3i"
              title: "Tool iteration"
              code: "for _, block := range msg.Content {"
              file: "main.go"
              line: 268
            children:
              - text: "Executes each tool_use block"
                children:
                  - block:
                      id: "3j"
                      title: "Tool execute"
                      code: "result := tools.Execute(block.Name, block.Input)"
                      file: "main.go"
                      line: 270
                    children:
                      - text: "Renders tool output"
                        children:
                          - block:
                              id: "3k"
                              title: "Render result"
                              code: "result.Render()"
                              file: "main.go"
                              line: 271
                      - text: "Builds tool result for API response"
                        children:
                          - block:
                              id: "3l"
                              title: "Build result"
                              code: "toolResults = append(toolResults, claude.ToolResultBlock{"
                              file: "main.go"
                              line: 280
      - text: "Breaks loop if no tool calls"
        children:
          - block:
              id: "3m"
              title: "No tools break"
              code: "if len(toolResults) == 0 {"
              file: "main.go"
              line: 288
            children:
              - text: "Computes HasPendingTodos locally from sessionTodos"
                children:
                  - block:
                      id: "3n"
                      title: "Pending check"
                      code: |
                        hasPending := false
                        for _, t := range sessionTodos {
                            if t.Status == "pending" || t.Status == "in_progress" {
                                hasPending = true
                                break
                            }
                        }
                      file: "main.go"
                      line: 293
                    children:
                      - text: "Builds AgentState with HasPendingTodos field"
                        children:
                          - block:
                              id: "3o"
                              title: "AgentState"
                              code: "state := &AgentState{..., HasPendingTodos: hasPending}"
                              file: "main.go"
                              line: 300
                      - text: "Injects reminders and appends tool results"
                        children:
                          - block:
                              id: "3p"
                              title: "Get reminders"
                              code: "if reminders := GetReminders(state); reminders != \"\" {"
                              file: "main.go"
                              line: 305
                          - block:
                              id: "3q"
                              title: "Add tool results"
                              code: "messages = append(messages, claude.MessageParam{Role: \"user\", Content: toolResults})"
                              file: "main.go"
                              line: 310

  - id: 4
    title: "Tool Registry"
    summary: "Tool lookup and execution dispatch"
    tree:
      - text: "Execute dispatches by name from registry"
        children:
          - block:
              id: "4a"
              title: "Execute entry"
              code: "func Execute(name string, input json.RawMessage) Result {"
              file: "tools/tools.go"
              line: 96
            children:
              - text: "Checks skill tool restrictions"
                children:
                  - block:
                      id: "4b"
                      title: "Skill check"
                      code: "if allowedTools != nil && !allowedTools[name] {"
                      file: "tools/tools.go"
                      line: 98
              - text: "Looks up local tool in registry"
                children:
                  - block:
                      id: "4c"
                      title: "Registry lookup"
                      code: "if fn, ok := registry[name]; ok {"
                      file: "tools/tools.go"
                      line: 101
              - text: "Falls back to MCP server tools"
                children:
                  - block:
                      id: "4d"
                      title: "MCP fallback"
                      code: "if result, found := globalMCPClients.Execute(context.Background(), name, input); found {"
                      file: "tools/tools.go"
                      line: 106

  - id: 5
    title: "Session Persistence"
    summary: "Saves state after each user turn"
    tree:
      - text: "After agentic loop completes, saves session using sessionTodos directly"
        children:
          - block:
              id: "5a"
              title: "Save session"
              code: "saveSession(sessionID, messages, sessionTodos, planMode, tools.GetPermissionsMode())"
              file: "main.go"
              line: 314
            children:
              - text: "Increments turn counter for reminder system"
                children:
                  - block:
                      id: "5b"
                      title: "Increment counter"
                      code: "turnsSinceTodoWrite++"
                      file: "main.go"
                      line: 316
