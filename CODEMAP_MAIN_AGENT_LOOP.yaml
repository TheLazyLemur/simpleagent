title: "Main Agent Loop"
created: "2026-01-11T00:00:00Z"
summary: "CLI agentic loop: user input -> API stream -> tool execution -> repeat"
description: |
  ## Overview
  The main agent loop in [1a] reads user input, sends to Claude API [2a],
  streams responses [3e], executes tools [3m], and persists sessions [5a].

  ## Key Flow
  1. Initialization: globals, client setup, session load/create, tools.Init [1a-1k]
  2. Input handling: commands, bash shortcuts, user messages [2a-2f]
  3. Agentic loop: fetchResponse [3e], text render [3j], executeTools [3m], reminders [3t]
  4. Tool registry: dispatch and execution [4a-4d]
  5. Persistence: session save after each user turn [5a-5b]

sections:
  - id: 1
    title: "Initialization"
    summary: "Globals, client setup, session management, tools.Init (now in cli.go AgentSession)"
    tree:
      - text: "Package-level globals for session state"
        children:
          - block:
              id: "1a"
              title: "Session todos global"
              code: "sessionTodos []tools.Todo"
              file: "main.go"
              line: 74
          - block:
              id: "1b"
              title: "Skill loader helper"
              code: "func makeSkillLoader() func(string) (*tools.SkillInfo, error) {"
              file: "main.go"
              line: 56
      - text: "Entry point parses flags, dispatches to AgentSession"
        children:
          - block:
              id: "1c"
              title: "Flag parsing"
              code: "resumeFlag := flag.String(\"resume\", \"\", \"Resume a session by ID\")"
              file: "main.go"
              line: 91
            children:
              - text: "AgentSession orchestrates initialization and agent loop"
                children:
                  - block:
                      id: "1d"
                      title: "AgentSession entry"
                      code: "func AgentSession(resumeFlag *string) error {"
                      file: "cli.go"
                      line: 28
                    children:
                      - text: "Creates Claude client with configured base URL"
                        children:
                          - block:
                              id: "1e"
                              title: "Client creation"
                              code: "client := claude.NewClient(claude.WithBaseURL(baseURL))"
                              file: "cli.go"
                              line: 29
                      - text: "Loads or creates session based on resume flag"
                        children:
                          - block:
                              id: "1f"
                              title: "Session resume"
                              code: "sess, err = loadSession(*resumeFlag)"
                              file: "cli.go"
                              line: 37
                          - block:
                              id: "1g"
                              title: "New session"
                              code: "sessionID = newSessionID()"
                              file: "cli.go"
                              line: 55
      - text: "Builds system prompt and loads config"
        children:
          - block:
              id: "1h"
              title: "System prompt + config"
              code: "systemPrompt, loadedFiles, config, err := BuildSystemPrompt()"
              file: "cli.go"
              line: 63
            children:
              - text: "Loads MCP servers from config"
                children:
                  - block:
                      id: "1i"
                      title: "MCP client init"
                      code: "mcpClients = tools.NewMCPClients(ctx, config.MCPServers)"
                      file: "cli.go"
                      line: 72
                    children:
                      - text: "Single tools.Init call configures all tool dependencies"
                        children:
                          - block:
                              id: "1j"
                              title: "tools.Init"
                              code: |
                                tools.Init(tools.Config{
                                    MCPClients:      mcpClients,
                                    PermissionsMode: permissionsMode,
                                    RuleMatcher:     GetMatchingRules,
                                    SkillLoader:     makeSkillLoader(),
                                    Todos:           &sessionTodos,
                                    Subagent: &tools.SubagentConfig{...},
                                })
                              file: "cli.go"
                              line: 85
                      - text: "Creates Agent instance with session state"
                        children:
                          - block:
                              id: "1k"
                              title: "NewAgent"
                              code: "agent, err := NewAgent(sessionID, sess, client, reader, systemPrompt, model, mcpClients, &sessionTodos)"
                              file: "cli.go"
                              line: 99

  - id: 2
    title: "Input Loop"
    summary: "User input handling and command processing (now in cli.go and agent.go)"
    tree:
      - text: "Infinite loop waits for user input in AgentSession"
        children:
          - block:
              id: "2a"
              title: "Main loop start"
              code: "for {"
              file: "cli.go"
              line: 105
            children:
              - text: "Reads multi-line input with continuation support"
                children:
                  - block:
                      id: "2b"
                      title: "Read input"
                      code: "input := readMultiLine(reader)"
                      file: "cli.go"
                      line: 107
                    children:
                      - text: "HandleInput processes commands and user messages"
                        children:
                          - block:
                              id: "2c"
                              title: "HandleInput call"
                              code: "shouldInfer, err := agent.HandleInput(input)"
                              file: "cli.go"
                              line: 113
                            children:
                              - text: "Handles /plan command to toggle plan mode"
                                children:
                                  - block:
                                      id: "2d"
                                      title: "Plan toggle"
                                      code: "if input == \"/plan\" {"
                                      file: "agent.go"
                                      line: 71
                              - text: "Handles !! prefix for bash with context"
                                children:
                                  - block:
                                      id: "2e"
                                      title: "Bash context"
                                      code: "if after, ok := strings.CutPrefix(input, \"!!\"); ok {"
                                      file: "agent.go"
                                      line: 78
                              - text: "Appends user message to conversation"
                                children:
                                  - block:
                                      id: "2f"
                                      title: "Add user msg"
                                      code: "a.messages = append(a.messages, claude.MessageParam{Role: \"user\", Content: input})"
                                      file: "agent.go"
                                      line: 97

  - id: 3
    title: "Agentic Loop"
    summary: "API streaming, response handling, tool execution (agent.go: fetchResponse, executeTools, RunInferenceTurn)"
    tree:
      - text: "RunInferenceTurn called from AgentSession main loop"
        children:
          - block:
              id: "3a"
              title: "RunInferenceTurn call"
              code: "if err := agent.RunInferenceTurn(); err != nil {"
              file: "cli.go"
              line: 137
            children:
              - text: "Inner loop continues until no tool calls"
                children:
                  - block:
                      id: "3b"
                      title: "RunInferenceTurn entry"
                      code: "func (a *Agent) RunInferenceTurn() error {"
                      file: "agent.go"
                      line: 166
                    children:
                      - text: "Selects tool set based on plan mode"
                        children:
                          - block:
                              id: "3c"
                              title: "Tool selection"
                              code: |
                                toolSet := tools.All()
                                if a.planMode {
                                    toolSet = tools.ReadOnly()
                                }
                              file: "agent.go"
                              line: 169
                            children:
                              - text: "Calls fetchResponse helper for streaming"
                                children:
                                  - block:
                                      id: "3d"
                                      title: "fetchResponse call"
                                      code: "msg, text, err := a.fetchResponse(toolSet)"
                                      file: "agent.go"
                                      line: 174
      - text: "fetchResponse: streaming + callbacks + final message"
        children:
          - block:
              id: "3e"
              title: "fetchResponse entry"
              code: "func (a *Agent) fetchResponse(toolSet []claude.Tool) (*claude.Message, string, error) {"
              file: "agent.go"
              line: 113
            children:
              - text: "Streams API request with thinking enabled"
                children:
                  - block:
                      id: "3f"
                      title: "API stream"
                      code: "stream := a.client.Messages.Stream(claude.MessageCreateParams{"
                      file: "agent.go"
                      line: 115
                    children:
                      - text: "Registers streaming callbacks for text and thinking"
                        children:
                          - block:
                              id: "3g"
                              title: "Text callback"
                              code: "stream.OnText(func(s string) {"
                              file: "agent.go"
                              line: 125
                          - block:
                              id: "3h"
                              title: "Thinking callback"
                              code: "stream.OnThinking(func(s string) {"
                              file: "agent.go"
                              line: 128
                      - text: "Waits for final message"
                        children:
                          - block:
                              id: "3i"
                              title: "Final message"
                              code: "msg, err := stream.FinalMessage()"
                              file: "agent.go"
                              line: 132
      - text: "RunInferenceTurn: renders text after fetchResponse"
        children:
          - block:
              id: "3j"
              title: "Render text"
              code: "if rendered, err := mdRenderer.Render(text); err == nil {"
              file: "agent.go"
              line: 184
            children:
              - text: "Appends assistant message to history"
                children:
                  - block:
                      id: "3k"
                      title: "Add assistant msg"
                      code: "a.messages = append(a.messages, claude.MessageParam{Role: \"assistant\", Content: msg.Content})"
                      file: "agent.go"
                      line: 194
      - text: "Calls executeTools helper for tool execution"
        children:
          - block:
              id: "3l"
              title: "executeTools call"
              code: "toolResults := a.executeTools(msg.Content)"
              file: "agent.go"
              line: 196
            children:
              - text: "executeTools: iterates content blocks, executes tool_use"
                children:
                  - block:
                      id: "3m"
                      title: "executeTools entry"
                      code: "func (a *Agent) executeTools(blocks []claude.ContentBlock) []claude.ToolResultBlock {"
                      file: "agent.go"
                      line: 139
                    children:
                      - text: "Executes each tool_use block"
                        children:
                          - block:
                              id: "3n"
                              title: "Tool execute"
                              code: "result := tools.Execute(block.Name, block.Input)"
                              file: "agent.go"
                              line: 146
                          - block:
                              id: "3o"
                              title: "Render result"
                              code: "result.Render()"
                              file: "agent.go"
                              line: 147
                      - text: "Builds tool result for API response"
                        children:
                          - block:
                              id: "3p"
                              title: "Build result"
                              code: "results = append(results, claude.ToolResultBlock{"
                              file: "agent.go"
                              line: 157
      - text: "Breaks loop if no tool calls"
        children:
          - block:
              id: "3q"
              title: "No tools break"
              code: "if len(toolResults) == 0 {"
              file: "agent.go"
              line: 197
            children:
              - text: "Computes HasPendingTodos from agent's todos"
                children:
                  - block:
                      id: "3r"
                      title: "Pending check"
                      code: |
                        hasPending := false
                        for _, t := range *a.todos {
                            if t.Status == "pending" || t.Status == "in_progress" {
                                hasPending = true
                                break
                            }
                        }
                      file: "agent.go"
                      line: 202
                    children:
                      - text: "Builds AgentState with HasPendingTodos field"
                        children:
                          - block:
                              id: "3s"
                              title: "AgentState"
                              code: "state := &AgentState{..., HasPendingTodos: hasPending}"
                              file: "agent.go"
                              line: 209
                      - text: "Injects reminders and appends tool results"
                        children:
                          - block:
                              id: "3t"
                              title: "Get reminders"
                              code: "if reminders := GetReminders(state); reminders != \"\" {"
                              file: "agent.go"
                              line: 214
                          - block:
                              id: "3u"
                              title: "Add tool results"
                              code: "a.messages = append(a.messages, claude.MessageParam{Role: \"user\", Content: toolResults})"
                              file: "agent.go"
                              line: 219

  - id: 4
    title: "Tool Registry"
    summary: "Tool lookup and execution dispatch"
    tree:
      - text: "Execute dispatches by name from registry"
        children:
          - block:
              id: "4a"
              title: "Execute entry"
              code: "func Execute(name string, input json.RawMessage) Result {"
              file: "tools/tools.go"
              line: 131
            children:
              - text: "Checks skill tool restrictions"
                children:
                  - block:
                      id: "4b"
                      title: "Skill check"
                      code: "if allowedTools != nil && !allowedTools[name] {"
                      file: "tools/tools.go"
                      line: 133
              - text: "Looks up local tool in registry"
                children:
                  - block:
                      id: "4c"
                      title: "Registry lookup"
                      code: "if fn, ok := registry[name]; ok {"
                      file: "tools/tools.go"
                      line: 136
              - text: "Falls back to MCP server tools"
                children:
                  - block:
                      id: "4d"
                      title: "MCP fallback"
                      code: "if result, found := globalMCPClients.Execute(context.Background(), name, input); found {"
                      file: "tools/tools.go"
                      line: 141

  - id: 5
    title: "Session Persistence"
    summary: "Saves state after each user turn (now in agent.go Save)"
    tree:
      - text: "After agentic loop completes, calls agent.Save() from AgentSession"
        children:
          - block:
              id: "5a"
              title: "Save call site"
              code: |
                if err := agent.Save(); err != nil {
                    fmt.Println(tools.Error(...))
                }
              file: "cli.go"
              line: 142
            children:
              - text: "Save method persists session and increments counter"
                children:
                  - block:
                      id: "5b"
                      title: "Save method"
                      code: |
                        func (a *Agent) Save() error {
                            if a.sessionID == "" { return nil }
                            if err := saveSession(a.sessionID, a.messages, *a.todos, a.planMode, a.permissionsMode); err != nil {
                                return err
                            }
                            a.turnsSinceTodoWrite++
                            return nil
                        }
                      file: "agent.go"
                      line: 102
